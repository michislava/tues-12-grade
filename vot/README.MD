# ВОТ - Виртуализация и облачни технологии

lyubomir.stoyanov@oblak.bg
#### Съдържание:

## Какво е виртуализация?
Виртуализацията като технология позволява да бъдат създадени виртуални
репрезентации на сървъри, storage, networks и други физически машини. 

Виртуалният софтуер пресъздава функциите на физическия hw, което позволява няколко (n на брой) виртуални машини
да работят едновременно на една физическа машина.

Виртуализацията се използва с цел хардуерните ресурси да се използват по-ефективно. Затова съществуват cloud computing services, които менажират инфраструктурата по-ефикасно.

## Защо виртуализацията е важна?
Виртуализацията предоставя много повече възможности за взаимодействие с някакъв хардуерен ресурс.

Физическите сървъри консумират:
- Електричество
- Storage space (Пространство)
- Нуждаят се от поддрържа - конфигурации и тн.

Виртуализацията премахва тези ограничения като прави ***абстракция*** на
функционалностите на физическия hw в софтуер.

*Например:* Комапния има нужда от сървъри с три функции:
- Store business email securely 
- Run a customer-facing application 
- Run internal business applications

Всяка една от тези функционалности изисква различни ресурси
- За първата (email application) е нужно: more storage capacity & Windows OS
- За втората (customer-facing application) е нужно: Linux OS & high processing power to handle large volumes of website traffic
- За третата (internal business application) е нужно: iOS & more internal memory (RAM)

***Efficiant hw use***

Вместо да бъдат използвани три различни сървъра с виртуализация могат да бъдат създадени три дигитални сървъра (виртуали машини) само на един физически сървър.

***IaaS***

Компанията може да използва cloud instance или VMs от cloud computing provider (АWS, Azure, Google Cloud). 
AWS manages all the underlying hardware, and the company can request server resources with varying configurations. 
All the applications run on these virtual servers without the users noticing any difference.

[Qemu](https://en.wikipedia.org/wiki/QEMU) - първа имплементация (най-дъртото)

[KVM -  Kernel-based VM](https://en.wikipedia.org/wiki/Kernel-based_Virtual_Machine)

## Основни концепции за виртуализацията

*Отново понятие за виртуализация:* Процес, който позволява hw ресурси да се споделят, използват едновременно от различни, отделени една от друга среди.
Всяка виртуализирана среда използва разпределените за нея ресурси като:
- Memory
- Processing power
- Storage

### VM & HV 

#### Виртуална машина

Виртуалната машина е софтуерно-дефиниран компютър, който работи върху физическо компютър, с отделена ОС и компютърни ресурси.
- физическият компютър е *host* машината
- VM е *guest* машината

VMs са абстрахирани от компютърния hw чрез хипервайзор.

#### Хипервайзор

Хипервайзорът е софтуер, който менажира VMs на компютър.
HV прави абстракция на hw ресурси, така че всяка VM да получи разпределените за нея ресурси и по никакъв начин да не се намесва в работата на другите VMs.

Хипервайзорът прави виртуалзацията възможна.

Има два типа HV (два типа на пълна виртуализация):
- Тип 1 HV (bare metal HV)

hv - overlay - псевдо ОС (междинен слой между BIOS и guest OSs)

липсва ОС на хоста => Директно се достъпват ресурсите на машината. Кърнълът има само функции за виртуализация 

Примери: KVM, ESXi, MS Hyper-V
- Tип 2 HV 

на хоста има ОС => HV минава през ОС на хоста, за да достигне до hw
Също така ОС на host-a приоритизира своите функции и апликации отколкото тези на VM.
=> Процесите са по-бавни и по-малк ефикасни със сравнение с тип 1. Повече latency

тип 2 hv е инсталиран върху ОС

Примери: Oracle VM Virtual Box, VMware Workstation

KDM - единствената виртуализация, която не се квалифицира в тип (може да е и 1, и 2)

Latency - колко време отнема изпълняването на команда (изпълняване и връщане на отговор)

Може да се направи така, че да се прескочи layer на kernel-ът (промяна на prefix: -1  в execution stake) т.е. VM да прескочи layer при виртуализация тип 2 и по този начин да се намали latency (да е бърза като тип 1, да локира и да чете)
### Диспечер на задачите в linux (2 функц модула):
Изолиране на процесите в linux системи 

#### [Cgroups & Namespaces](https://www.nginx.com/blog/what-are-namespaces-cgroups-how-do-they-work/)

- Control groups - cgroups

Менажират и ограничават системните ресурси (като CPU, memory, netw bandwidth и др.) за различни групи от процеси.
Контрол групите имат йерархична структура

- Namespace

Основна функция: *Да изолират процесите един от друг*

Предоставят процес със своя собствена изолирана среда

Различни типове в Linux:
- Mount: isolates a process’s view of the filesystem 
- PID: isolates a process’s view of the process tree 
- Network: isolates a process’s view of the network stack 
- User: isolates a process’s view of user and group IDs

Те често се комбинират със cgroups, за да осигурят изолиране на контейнерите и управление на ресурсите.

## Контейнеризация

Контейнеризацията, представляваща енкапсулацията на някакъв софтуер, предоставя удобство,
защото се създава среда за софтуера с всички нужни dependency-tа, библиотеки (DDL - dynamic link library) и т.н. нужни за изпълнението
на програмата успешно.

При контейнеризацията ако kernel-ът падне всичко пада. Тясна зависимост с host-а.
Различава се от пълната виртуализация, деляща се на тип 1 и тип 2.

Контейнерите са на основата на механизма на LXC, но са по-user-friendly. Основна цел: за миграция, да могат да бъдат преместени върху инфраструктурата на друга операционна система или друга среда.
Контейнерът е по-бърз, защото е малък.

Виртуализацията поддържа изпълнението на множество операционни системи на един физически сървър, докато контейнеризацията поддържа внедряването на множество приложения, разработени в средата на една операционна система, разположена на една виртуална машина или сървър.

С Dockerfile се build-ва image. В него се описват всичките необходими build steps:  
- Първо се подава съществуващ image (от DockerHub - публично хранилище, Dockerhub за Docker е малко като GitHub за Git) на операционна система, на която има python.
```bash
FROM python:3.9-slim-buster
# lightweight linux os with python installed
```
- Създава се папка (work directory) в контейнера, в която ще бъде приложението.
```bash
WORKDIR /app
```
-  Преди да се копира цялото приложение в image на отделна стъпка копирам само requirements.txt.
```bash
COPY requirements.txt requirements.txt
#copy requirements.txt into the image
```
- С вече създадения requirements файл и pip (който имаме от python image свален в първата стъпка), се инсталират нужните модули (библиотеки)
```bash
RUN pip install -r requirements.txt
# pip installs modules into the image
```
- Всичко от текущата папка на целият проект се копира в workdir /app, създаден във втората стъпка.
```bash
COPY . .
# adding source code into the image (all files in the working directory)
```
- Стартиране на приложението в контейнер image с:
```bash
CMD ["python3", "app.py"]
```
